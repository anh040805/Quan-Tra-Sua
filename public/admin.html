<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Tr√† S·ªØa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f6f9; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: #2c3e50; color: white; display: flex; flex-direction: column; }
        .brand { font-size: 22px; font-weight: bold; padding: 20px; text-align: center; background: #1a252f; border-bottom: 1px solid #34495e; }
        .menu-item { padding: 15px 20px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: #34495e; border-left: 4px solid #3498db; }
        
        /* MAIN CONTENT */
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .stat-info h3 { margin: 0; font-size: 28px; color: #2c3e50; }
        .stat-info p { margin: 5px 0 0; color: #7f8c8d; }
        .stat-icon { font-size: 40px; opacity: 0.2; }

        /* POS INTERFACE */
        .pos-container { display: flex; gap: 20px; height: 85vh; }
        .pos-menu { flex: 2; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding-right: 10px; }
        .pos-product { background: white; padding: 10px; border-radius: 10px; cursor: pointer; text-align: center; border: 1px solid #eee; transition: 0.2s; }
        .pos-product:hover { border-color: #3498db; transform: translateY(-3px); }
        .pos-product img { width: 80px; height: 80px; object-fit: contain; }
        
        .pos-sidebar { flex: 1; background: white; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; }
        .cart-items { flex: 1; overflow-y: auto; margin: 15px 0; border-top: 1px dashed #eee; border-bottom: 1px dashed #eee; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f1f1; }
        .btn-pay { background: #27ae60; color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* TABLES INTERFACE */
        .table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .table-card { height: 120px; border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; color: white; font-weight: bold; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .table-card.empty { background: #2ecc71; } /* Xanh: Tr·ªëng */
        .table-card.busy { background: #e74c3c; } /* ƒê·ªè: C√≥ kh√°ch */
        .table-card i { font-size: 30px; margin-bottom: 10px; }
        
        /* BUTTONS */
        .btn-action { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; background: #3498db; color: white; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">QU·∫¢N L√ù TR√Ä S·ªÆA</div>
        <div class="menu-item active" onclick="showSection('dashboard')">
            <i class="fas fa-home"></i> T·ªïng Quan
        </div>
        <div class="menu-item" onclick="showSection('orders')">
            <i class="fas fa-list-alt"></i> ƒê∆°n H√†ng Online
        </div>
        <div class="menu-item" onclick="showSection('pos')">
            <i class="fas fa-cash-register"></i> B√°n H√†ng (POS)
        </div>
        <div class="menu-item" onclick="showSection('tables')">
            <i class="fas fa-th"></i> Qu·∫£n L√Ω B√†n
        </div>
        <div class="menu-item" onclick="showSection('stats')">
            <i class="fas fa-chart-bar"></i> B√°o C√°o Doanh Thu
        </div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="section active">
            <h2>T·ªïng Quan H√¥m Nay</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info">
                        <h3 id="total-revenue">0ƒë</h3>
                        <p>T·ªïng Doanh Thu</p>
                    </div>
                    <i class="fas fa-dollar-sign stat-icon" style="color: #27ae60;"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3 id="total-orders">0</h3>
                        <p>ƒê∆°n H√†ng</p>
                    </div>
                    <i class="fas fa-shopping-cart stat-icon" style="color: #f39c12;"></i>
                </div>
            </div>
            
            <div class="section" style="display: block;">
                <h2>üìà Bi·ªÉu ƒê·ªì Doanh Thu (7 Ng√†y Qua)</h2>
                <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); height: 400px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <div id="orders" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üì¶ ƒê∆°n H√†ng M·ªõi</h2>
                <button onclick="loadOrders()" class="btn-action">üîÑ L√†m m·ªõi</button>
            </div>
            <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-top: 15px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                            <th style="padding: 15px; text-align: left;">Th·ªùi gian</th>
                            <th style="padding: 15px; text-align: left;">Kh√°ch h√†ng</th>
                            <th style="padding: 15px; text-align: left;">M√≥n ƒë·∫∑t</th>
                            <th style="padding: 15px; text-align: left;">T·ªïng ti·ªÅn</th>
                            <th style="padding: 15px; text-align: left;">Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="order-list-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="pos" class="section">
            <div class="pos-container">
                <div class="pos-menu" id="pos-menu">
                    </div>
                <div class="pos-sidebar">
                    <h3>Gi·ªè H√†ng</h3>
                    <select id="select-table" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                        <option value="">-- Ch·ªçn B√†n ho·∫∑c Mang V·ªÅ --</option>
                    </select>
                    <div class="cart-items" id="pos-cart">
                        <p style="text-align:center; color:#999">Ch∆∞a ch·ªçn m√≥n</p>
                    </div>
                    <h2 style="text-align: right; color: #e74c3c;" id="pos-total">0ƒë</h2>
                    <button class="btn-pay" onclick="processPayment()">THANH TO√ÅN</button>
                </div>
            </div>
        </div>

        <div id="tables" class="section">
            <h2>Tr·∫°ng Th√°i B√†n</h2>
            <p>B·∫•m v√†o b√†n ƒë·ªÉ d·ªçn b√†n (chuy·ªÉn v·ªÅ tr·∫°ng th√°i Tr·ªëng)</p>
            <div class="table-grid" id="table-grid">
                </div>
        </div>

        <div id="stats" class="section">
            <h2>B√°o C√°o Doanh Thu Chi Ti·∫øt</h2>
            <p>Bi·ªÉu ƒë·ªì chi ti·∫øt doanh thu theo ng√†y trong th√°ng.</p>
            <div style="background: white; padding: 20px; border-radius: 10px; height: 400px;">
                <canvas id="detailedChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        let products = [];
        let cart = [];
        let tables = [];
        let myChart = null; // Khai b√°o bi·∫øn bi·ªÉu ƒë·ªì ch√≠nh 1 l·∫ßn

        // --- H√ÄM V·∫º BI·ªÇU ƒê·ªí (ƒê√£ s·ª≠a l·ªói c√∫ ph√°p) ---
        async function renderChart(dailyData) {
            try {
                // L·∫•y d·ªØ li·ªáu t·ª´ API ho·∫∑c t·ª´ loadStats truy·ªÅn v√†o
                const data = dailyData || (await (await fetch('/api/chart-data')).json());

                // N·∫øu API /api/stats tr·∫£ v·ªÅ daily l√† m·∫£ng tr·ª±c ti·∫øp
                const labels = data.map(item => item._id); 
                const values = data.map(item => item.total || item.dailyRevenue);

                if (myChart) myChart.destroy(); 
                
                const ctx = document.getElementById('revenueChart').getContext('2d');

                myChart = new Chart(ctx, { 
                    type: 'line', 
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Doanh thu (VNƒê)',
                            data: values,
                            borderColor: '#764ba2', 
                            backgroundColor: 'rgba(118, 75, 162, 0.2)', 
                            borderWidth: 3,
                            tension: 0.4, 
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // V·∫Ω bi·ªÉu ƒë·ªì ·ªü tab Th·ªëng k√™ chi ti·∫øt
                const ctx2 = document.getElementById('detailedChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Doanh Thu Theo Ng√†y',
                            data: values,
                            borderColor: '#e74c3c',
                            fill: false
                        }]
                    }
                });

            } catch(e) {
                console.error("L·ªói v·∫Ω bi·ªÉu ƒë·ªì:", e);
                // Bi·ªÉu ƒë·ªì s·∫Ω kh√¥ng hi·ªÉn th·ªã n·∫øu API /api/chart-data ho·∫∑c /api/stats b·ªã l·ªói
            }
        }


        // --- LOGIC TH·ªêNG K√ä (DASHBOARD) ---
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();

                // S·ª≠a logic: S·ª≠ d·ª•ng totalRevenue v√† totalOrders cho th·∫ª th·ªëng k√™
                document.getElementById('total-revenue').innerText = (data.totalRevenue || 0).toLocaleString() + 'ƒë';
                document.getElementById('total-orders').innerText = data.totalOrders || 0;

                // G·ªçi h√†m v·∫Ω bi·ªÉu ƒë·ªì sau khi t·∫£i th·ªëng k√™ xong, truy·ªÅn d·ªØ li·ªáu daily (n·∫øu API /api/stats c√≥ tr·∫£ v·ªÅ daily)
                renderChart(data.daily); 

            } catch (error) {
                console.error("L·ªói t·∫£i th·ªëng k√™:", error);
            }
        }

        // --- LOGIC QU·∫¢N L√ù ƒê∆†N H√ÄNG ---
        async function loadOrders() {
            try {
                const res = await fetch('/api/all-orders');
                const orders = await res.json();
                
                const tbody = document.getElementById('order-list-body');
                if(orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 15px;">${new Date(order.createdAt).toLocaleString()}</td>
                        <td style="padding: 15px;">
                            <b>${order.customerName}</b><br>
                            <small>${order.phone || 'T·∫°i b√†n'}</small>
                        </td>
                        <td style="padding: 15px;">
                            ${order.items.map(i => `<div>- ${i.name}</div>`).join('')}
                        </td>
                        <td style="padding: 15px; color:#c0392b; font-weight:bold;">
                            ${order.totalPrice.toLocaleString()}ƒë
                        </td>
                        <td style="padding: 15px;">
                            <span style="background:#d4edda; color:#155724; padding:5px 10px; border-radius:15px; font-size:12px;">
                                ${order.status || 'M·ªõi ƒë·∫∑t'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error("L·ªói t·∫£i ƒë∆°n h√†ng:", e); }
        }

        // --- LOGIC POS (B√ÅN H√ÄNG) ---
        async function loadPOS() {
            // L·∫•y m√≥n ƒÉn
            const resP = await fetch('/api/products');
            products = await resP.json();
            const menuContainer = document.getElementById('pos-menu');
            menuContainer.innerHTML = products.map(p => `
                <div class="pos-product" onclick="addToCart('${p._id}')">
                    <img src="${p.image}">
                    <b>${p.name}</b><br>
                    <span style="color:red">${p.price.toLocaleString()}ƒë</span>
                </div>
            `).join('');

            // L·∫•y danh s√°ch b√†n ƒë·ªÉ ch·ªçn
            loadTableOptions();
        }

        async function loadTableOptions() {
            const resT = await fetch('/api/tables');
            tables = await resT.json(); // C·∫≠p nh·∫≠t bi·∫øn tables global
            const select = document.getElementById('select-table');
            select.innerHTML = '<option value="">-- Ch·ªçn B√†n / Mang V·ªÅ --</option>';
            tables.forEach(t => {
                select.innerHTML += `<option value="${t._id}" ${t.status === 'busy' ? 'disabled' : ''}>${t.name} (${t.status === 'busy' ? 'ƒêang c√≥ kh√°ch' : 'Tr·ªëng'})</option>`;
            });
        }

        function addToCart(id) {
            const p = products.find(x => x._id === id);
            cart.push(p);
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('pos-cart');
            let total = 0;
            container.innerHTML = cart.map((item, idx) => {
                total += item.price;
                return `
                <div class="cart-item">
                    <span>${item.name}</span>
                    <b>${item.price.toLocaleString()}</b>
                    <i class="fas fa-trash" style="color:red; cursor:pointer" onclick="cart.splice(${idx},1); renderCart()"></i>
                </div>`;
            }).join('');
            document.getElementById('pos-total').innerText = total.toLocaleString() + 'ƒë';
        }

        async function processPayment() {
            if(cart.length === 0) return alert("Ch∆∞a ch·ªçn m√≥n!");
            const tableId = document.getElementById('select-table').value;
            
            const table = tables.find(t => t._id === tableId); // T√¨m th√¥ng tin b√†n

            const orderData = {
                customerName: table ? `Kh√°ch B√†n ${table.name.replace('B√†n ', '')}` : "Kh√°ch mang v·ªÅ",
                totalPrice: cart.reduce((sum, i) => sum + i.price, 0),
                items: cart,
                tableId: tableId || null,
                phone: "" 
            };

            await fetch('/api/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(orderData)
            });

            // N·∫øu thanh to√°n t·∫°i b√†n, c·∫≠p nh·∫≠t tr·∫°ng th√°i b√†n th√†nh busy
            if (tableId) {
                 await fetch(`/api/tables/${tableId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'busy' })
                });
                loadTableOptions(); // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i b√†n trong select
            }
           
            alert("‚úÖ Thanh to√°n th√†nh c√¥ng! In h√≥a ƒë∆°n...");
            cart = [];
            renderCart();
        }


        // --- LOGIC QU·∫¢N L√ù B√ÄN ---
        async function loadTables() {
            const res = await fetch('/api/tables');
            tables = await res.json();
            const grid = document.getElementById('table-grid');
            
            grid.innerHTML = tables.map(t => `
                <div class="table-card ${t.status}" onclick="resetTable('${t._id}', '${t.status}')">
                    <i class="fas fa-${t.status === 'empty' ? 'chair' : 'user-check'}"></i>
                    <span>${t.name}</span>
                    <small>${t.status === 'empty' ? 'TR·ªêNG' : 'C√ì KH√ÅCH'}</small>
                </div>
            `).join('');
        }

        async function resetTable(id, currentStatus) {
            if(currentStatus === 'empty') return alert("B√†n n√†y ƒëang tr·ªëng r·ªìi!");
            if(!confirm("Kh√°ch ƒë√£ v·ªÅ? D·ªçn b√†n n√†y th√†nh TR·ªêNG?")) return;

            await fetch(`/api/tables/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ status: 'empty' })
            });
            loadTables(); // Load l·∫°i giao di·ªán
        }


        // --- ƒêI·ªÄU H∆Ø·ªöNG V√Ä KH·ªûI T·∫†O (ƒê√£ s·ª≠a l·ªói tr√πng h√†m) ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            
            // T√¨m n√∫t b·∫•m v√† th√™m class 'active'
            const menuItem = document.querySelector(`.menu-item[onclick="showSection('${id}')"]`);
            if(menuItem) menuItem.classList.add('active');


            // T·∫£i d·ªØ li·ªáu theo tab
            if(id === 'dashboard' || id === 'stats') loadStats();
            if(id === 'pos') loadPOS();
            if(id === 'tables') loadTables();
            if(id === 'orders') loadOrders();
        }

        // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
        showSection('dashboard'); 

        // T·ª± ƒë·ªông t·∫£i ƒë∆°n h√†ng m·ªõi m·ªói 10 gi√¢y
        setInterval(() => {
            if(document.getElementById('orders') && document.getElementById('orders').classList.contains('active')) {
                loadOrders();
            }
        }, 10000);
    </script>

</body>
</html>