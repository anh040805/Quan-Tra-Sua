<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Trà Sữa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f6f9; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: #2c3e50; color: white; display: flex; flex-direction: column; }
        .brand { font-size: 22px; font-weight: bold; padding: 20px; text-align: center; background: #1a252f; border-bottom: 1px solid #34495e; }
        .menu-item { padding: 15px 20px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: #34495e; border-left: 4px solid #3498db; }
        
        /* MAIN CONTENT */
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .stat-info h3 { margin: 0; font-size: 28px; color: #2c3e50; }
        .stat-info p { margin: 5px 0 0; color: #7f8c8d; }
        .stat-icon { font-size: 40px; opacity: 0.2; }

        /* POS INTERFACE */
        .pos-container { display: flex; gap: 20px; height: 85vh; }
        .pos-menu { flex: 2; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding-right: 10px; }
        .pos-product { background: white; padding: 10px; border-radius: 10px; cursor: pointer; text-align: center; border: 1px solid #eee; transition: 0.2s; }
        .pos-product:hover { border-color: #3498db; transform: translateY(-3px); }
        .pos-product img { width: 80px; height: 80px; object-fit: contain; }
        
        .pos-sidebar { flex: 1; background: white; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; }
        .cart-items { flex: 1; overflow-y: auto; margin: 15px 0; border-top: 1px dashed #eee; border-bottom: 1px dashed #eee; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f1f1; }
        .btn-pay { background: #27ae60; color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* TABLES INTERFACE */
        .table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .table-card { height: 120px; border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; color: white; font-weight: bold; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .table-card.empty { background: #2ecc71; } /* Xanh: Trống */
        .table-card.busy { background: #e74c3c; } /* Đỏ: Có khách */
        .table-card i { font-size: 30px; margin-bottom: 10px; }
        
        /* BUTTONS */
        .btn-action { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; background: #3498db; color: white; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">QUẢN LÝ TRÀ SỮA</div>
        <div class="menu-item active" onclick="showSection('dashboard')">
            <i class="fas fa-home"></i> Tổng Quan
        </div>
        <div class="menu-item" onclick="showSection('pos')">
            <i class="fas fa-cash-register"></i> Bán Hàng (POS)
        </div>
        <div class="menu-item" onclick="showSection('tables')">
            <i class="fas fa-th"></i> Quản Lý Bàn
        </div>
        <div class="menu-item" onclick="showSection('stats')">
            <i class="fas fa-chart-bar"></i> Báo Cáo Doanh Thu
        </div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="section active">
            <h2>Tổng Quan Hôm Nay</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info">
                        <h3 id="total-revenue">0đ</h3>
                        <p>Tổng Doanh Thu</p>
                    </div>
                    <i class="fas fa-dollar-sign stat-icon" style="color: #27ae60;"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3 id="total-orders">0</h3>
                        <p>Đơn Hàng</p>
                    </div>
                    <i class="fas fa-shopping-cart stat-icon" style="color: #f39c12;"></i>
                </div>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 10px;">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div id="pos" class="section">
            <div class="pos-container">
                <div class="pos-menu" id="pos-menu">
                    </div>
                <div class="pos-sidebar">
                    <h3>Giỏ Hàng</h3>
                    <select id="select-table" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                        <option value="">-- Chọn Bàn hoặc Mang Về --</option>
                    </select>
                    <div class="cart-items" id="pos-cart">
                        <p style="text-align:center; color:#999">Chưa chọn món</p>
                    </div>
                    <h2 style="text-align: right; color: #e74c3c;" id="pos-total">0đ</h2>
                    <button class="btn-pay" onclick="processPayment()">THANH TOÁN</button>
                </div>
            </div>
        </div>

        <div id="tables" class="section">
            <h2>Trạng Thái Bàn</h2>
            <p>Bấm vào bàn để dọn bàn (chuyển về trạng thái Trống)</p>
            <div class="table-grid" id="table-grid">
                </div>
        </div>

        <div id="stats" class="section">
            <h2>Báo Cáo Doanh Thu</h2>
            <p>Biểu đồ chi tiết doanh thu theo ngày trong tháng.</p>
            <div style="background: white; padding: 20px; border-radius: 10px; height: 400px;">
                <canvas id="detailedChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        let products = [];
        let cart = [];
        let tables = [];
        let myChart = null;

        // --- ĐIỀU HƯỚNG ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if(id === 'dashboard' || id === 'stats') loadStats();
            if(id === 'pos') loadPOS();
            if(id === 'tables') loadTables();
        }

        // --- 1. LOGIC THỐNG KÊ (DASHBOARD) ---
        async function loadStats() {
            const res = await fetch('/api/stats');
            const data = await res.json();

            // Hiển thị số liệu
            document.getElementById('total-revenue').innerText = data.revenue.toLocaleString() + 'đ';
            document.getElementById('total-orders').innerText = data.orders;

            // Vẽ biểu đồ
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if(myChart) myChart.destroy(); // Xóa biểu đồ cũ nếu có

            const labels = data.daily.map(d => d._id);
            const values = data.daily.map(d => d.dailyRevenue);

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh Thu (VNĐ)',
                        data: values,
                        backgroundColor: '#3498db'
                    }]
                }
            });
            
            // Vẽ biểu đồ ở tab Thống kê chi tiết luôn
            const ctx2 = document.getElementById('detailedChart').getContext('2d');
            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh Thu Theo Ngày',
                        data: values,
                        borderColor: '#e74c3c',
                        fill: false
                    }]
                }
            });
        }

        // --- 2. LOGIC POS (BÁN HÀNG) ---
        async function loadPOS() {
            // Lấy món ăn
            const resP = await fetch('/api/products');
            products = await resP.json();
            const menuContainer = document.getElementById('pos-menu');
            menuContainer.innerHTML = products.map(p => `
                <div class="pos-product" onclick="addToCart('${p._id}')">
                    <img src="${p.image}">
                    <b>${p.name}</b><br>
                    <span style="color:red">${p.price.toLocaleString()}đ</span>
                </div>
            `).join('');

            // Lấy danh sách bàn để chọn
            loadTableOptions();
        }

        async function loadTableOptions() {
            const resT = await fetch('/api/tables');
            const tables = await resT.json();
            const select = document.getElementById('select-table');
            select.innerHTML = '<option value="">-- Chọn Bàn / Mang Về --</option>';
            tables.forEach(t => {
                select.innerHTML += `<option value="${t._id}">${t.name} (${t.status === 'busy' ? 'Đang có khách' : 'Trống'})</option>`;
            });
        }

        function addToCart(id) {
            const p = products.find(x => x._id === id);
            cart.push(p);
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('pos-cart');
            let total = 0;
            container.innerHTML = cart.map((item, idx) => {
                total += item.price;
                return `
                <div class="cart-item">
                    <span>${item.name}</span>
                    <b>${item.price.toLocaleString()}</b>
                    <i class="fas fa-trash" style="color:red; cursor:pointer" onclick="cart.splice(${idx},1); renderCart()"></i>
                </div>`;
            }).join('');
            document.getElementById('pos-total').innerText = total.toLocaleString() + 'đ';
        }

        async function processPayment() {
            if(cart.length === 0) return alert("Chưa chọn món!");
            const tableId = document.getElementById('select-table').value;
            
            const orderData = {
                customerName: "Khách tại quầy",
                totalPrice: cart.reduce((sum, i) => sum + i.price, 0),
                items: cart,
                tableId: tableId || null
            };

            await fetch('/api/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(orderData)
            });

            alert("✅ Thanh toán thành công! In hóa đơn...");
            cart = [];
            renderCart();
            loadTableOptions(); // Cập nhật lại trạng thái bàn trong select
        }

        // --- 3. LOGIC QUẢN LÝ BÀN ---
        async function loadTables() {
            const res = await fetch('/api/tables');
            tables = await res.json();
            const grid = document.getElementById('table-grid');
            
            grid.innerHTML = tables.map(t => `
                <div class="table-card ${t.status}" onclick="resetTable('${t._id}', '${t.status}')">
                    <i class="fas fa-${t.status === 'empty' ? 'chair' : 'user-check'}"></i>
                    <span>${t.name}</span>
                    <small>${t.status === 'empty' ? 'TRỐNG' : 'CÓ KHÁCH'}</small>
                </div>
            `).join('');
        }

        async function resetTable(id, currentStatus) {
            if(currentStatus === 'empty') return alert("Bàn này đang trống rồi!");
            if(!confirm("Khách đã về? Dọn bàn này thành TRỐNG?")) return;

            await fetch(`/api/tables/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ status: 'empty' })
            });
            loadTables(); // Load lại giao diện
        }

        // Mặc định load dashboard
        loadStats();
    </script>
</body>
</html>