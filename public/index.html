<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√† S·ªØa MongoDB Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff6b6b; --secondary: #4ecdc4; --dark: #292f36; --light: #f7fff7; }
        body { font-family: 'Quicksand', sans-serif; background-color: var(--light); margin: 0; color: var(--dark); }
        
        /* HEADER */
        .header { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 10px;}
        .nav-btn { background: none; border: 2px solid var(--secondary); color: var(--secondary); padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-left: 10px;}
        .nav-btn:hover { background: var(--secondary); color: white; }
        .cart-btn { background: var(--primary); color: white; border: none; }
        .cart-btn:hover { background: #ff4757; }

        /* MENU GRID */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .menu-title { text-align: center; margin-bottom: 30px; font-size: 28px; color: var(--dark); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        
        /* PRODUCT CARD */
        .card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; display: flex; flex-direction: column; justify-content: space-between; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card img { width: 120px; height: 120px; object-fit: contain; margin: 0 auto 15px; }
        .card h3 { margin: 10px 0 5px; font-size: 18px; }
        .card p { font-size: 13px; color: #666; flex-grow: 1; margin-bottom: 15px; }
        .price { font-size: 20px; font-weight: bold; color: var(--primary); margin-bottom: 15px; }
        .add-btn { width: 100%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .add-btn:hover { opacity: 0.9; }

        /* MODAL (POPUP) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 15px; max-height: 85vh; overflow-y: auto; position: relative; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #999; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* CART & HISTORY STYLES */
        .cart-item, .history-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .cart-total { text-align: right; font-size: 20px; font-weight: bold; margin-top: 20px; color: var(--primary); }
        .confirm-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        
        .history-card { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid var(--secondary); }
        .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; background: #ffeaa7; color: #d35400; }
    </style>
</head>
<body>

    <div class="header">
        <a href="#" class="logo">ü•§ TR√Ä S·ªÆA CLOUD</a>
        <div>
            <button class="nav-btn" onclick="openHistoryModal()">üìú L·ªãch s·ª≠ mua</button>
            <button class="nav-btn cart-btn" onclick="toggleCart()">üõí Gi·ªè h√†ng (<span id="cart-count">0</span>)</button>
        </div>
    </div>

    <div class="container">
        <h2 class="menu-title">‚ú® Menu H√¥m Nay ‚ú®</h2>
        <div id="product-list" class="product-grid">
            <p style="text-align:center; width: 100%;">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ MongoDB...</p>
        </div>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleCart()">&times;</span>
            <h2>Gi·ªè H√†ng C·ªßa B·∫°n</h2>
            <div id="cart-items-container">
                <p style="text-align: center; color: #999;">Ch∆∞a c√≥ m√≥n n√†o...</p>
            </div>
            <div class="cart-total">T·ªïng: <span id="total-price">0</span>ƒë</div>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ccc;">
            <h3>Th√¥ng tin giao h√†ng</h3>
            <div class="input-group">
                <label>H·ªç t√™n:</label>
                <input type="text" id="cus-name" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
            </div>
            <div class="input-group">
                <label>S·ªë ƒëi·ªán tho·∫°i (ƒë·ªÉ tra l·ªãch s·ª≠):</label>
                <input type="tel" id="cus-phone" placeholder="V√≠ d·ª•: 0909123456">
            </div>
            <div class="input-group">
                <label>ƒê·ªãa ch·ªâ:</label>
                <input type="text" id="cus-address" placeholder="V√≠ d·ª•: 123 ƒê∆∞·ªùng ABC...">
            </div>
            <button class="confirm-btn" onclick="checkout()">ƒê·∫∂T H√ÄNG NGAY</button>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHistoryModal()">&times;</span>
            <h2>Tra C·ª©u ƒê∆°n H√†ng</h2>
            <div class="input-group" style="display: flex; gap: 10px;">
                <input type="tel" id="search-phone" placeholder="Nh·∫≠p SƒêT c·ªßa b·∫°n...">
                <button onclick="searchHistory()" style="padding: 10px; background: var(--secondary); color: white; border: none; border-radius: 8px; cursor: pointer;">T√¨m</button>
            </div>
            <div id="history-results" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                </div>
        </div>
    </div>

    <script>
        let products = [];
        let cart = [];

        // 1. T·∫£i danh s√°ch s·∫£n ph·∫©m
        async function loadProducts() {
            try {
                const res = await fetch('/api/products');
                products = await res.json();
                
                // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu th√¨ g·ª£i √Ω t·∫°o
                if(products.length === 0) {
                    document.getElementById('product-list').innerHTML = 
                        `<div style="grid-column: 1/-1; text-align: center;">
                            <p>Menu ƒëang tr·ªëng.</p>
                            <a href="/api/init" style="color: blue; text-decoration: underline;">B·∫•m v√†o ƒë√¢y ƒë·ªÉ t·∫°o Menu m·∫´u</a>
                        </div>`;
                    return;
                }

                renderProducts(products);
            } catch (err) {
                console.error(err);
                document.getElementById('product-list').innerHTML = `<p style="color:red; text-align:center;">L·ªói k·∫øt n·ªëi Server!</p>`;
            }
        }

        function renderProducts(list) {
            const container = document.getElementById('product-list');
            container.innerHTML = list.map(p => `
                <div class="card">
                    <img src="${p.image}" alt="${p.name}">
                    <h3>${p.name}</h3>
                    <p>${p.description || 'Th∆°m ngon m·ªùi b·∫°n ƒÉn nha!'}</p>
                    <div class="price">${p.price.toLocaleString()}ƒë</div>
                    <button class="add-btn" onclick="addToCart('${p._id}')">Th√™m v√†o gi·ªè +</button>
                </div>
            `).join('');
        }

        // 2. Ch·ª©c nƒÉng Gi·ªè h√†ng
        function addToCart(id) {
            const product = products.find(p => p._id === id);
            cart.push(product);
            updateCartUI();
            toggleCart(true); // M·ªü gi·ªè h√†ng ngay khi th√™m
        }

        function removeFromCart(index) {
            cart.splice(index, 1); // X√≥a m√≥n t·∫°i v·ªã tr√≠ index
            updateCartUI();
        }

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.length;
            const container = document.getElementById('cart-items-container');
            const totalSpan = document.getElementById('total-price');
            
            let total = 0;
            if(cart.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Gi·ªè h√†ng tr·ªëng.</p>';
            } else {
                container.innerHTML = cart.map((item, index) => {
                    total += item.price;
                    return `
                        <div class="cart-item">
                            <div>
                                <b>${item.name}</b><br>
                                <small>${item.price.toLocaleString()}ƒë</small>
                            </div>
                            <button onclick="removeFromCart(${index})" style="background:none; border:none; color:red; cursor:pointer;">X√≥a</button>
                        </div>
                    `;
                }).join('');
            }
            totalSpan.innerText = total.toLocaleString();
        }

        function toggleCart(forceOpen = false) {
            const modal = document.getElementById('cartModal');
            if (forceOpen) modal.style.display = 'flex';
            else modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        // 3. Thanh to√°n (Checkout)
        async function checkout() {
            const name = document.getElementById('cus-name').value;
            const phone = document.getElementById('cus-phone').value;
            const address = document.getElementById('cus-address').value;

            if(cart.length === 0) return alert("Gi·ªè h√†ng ƒëang tr·ªëng!");
            if(!name || !phone || !address) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");

            const orderData = {
                customerName: name,
                phone: phone,
                address: address,
                items: cart,
                totalPrice: cart.reduce((sum, item) => sum + item.price, 0)
            };

            try {
                const res = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(orderData)
                });
                const result = await res.json();
                
                if(result.success) {
                    alert("‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n.");
                    cart = [];
                    updateCartUI();
                    toggleCart(); // ƒê√≥ng modal
                } else {
                    alert("L·ªói: " + result.message);
                }
            } catch (err) { alert("L·ªói k·∫øt n·ªëi!"); }
        }

        // 4. L·ªãch s·ª≠ mua h√†ng
        function openHistoryModal() {
            document.getElementById('historyModal').style.display = 'flex';
        }
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        async function searchHistory() {
            const phone = document.getElementById('search-phone').value;
            if(!phone) return alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!");

            const res = await fetch(`/api/history/${phone}`);
            const orders = await res.json();
            const container = document.getElementById('history-results');

            if(orders.length === 0) {
                container.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o v·ªõi SƒêT n√†y.</p>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="history-card">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${new Date(order.createdAt).toLocaleString()}</b>
                        <span class="status-badge">${order.status}</span>
                    </div>
                    <p>M√≥n: ${order.items.map(i => i.name).join(', ')}</p>
                    <p>T·ªïng ti·ªÅn: <b>${order.totalPrice.toLocaleString()}ƒë</b></p>
                    <small>Giao t·ªõi: ${order.address}</small>
                </div>
            `).join('');
        }

        // Kh·ªüi ch·∫°y
        loadProducts();
    </script>
</body>
</html>